<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar system</title>
    <link rel="stylesheet" href="styles/index.css">
</head>

<body>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.139.2/build/three.module.js"
          }
        }
      </script>
    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.139.2/examples/jsm/controls/OrbitControls.js';
        import { GLTFLoader } from "https://unpkg.com/three@0.139.2/examples/jsm/loaders/GLTFLoader.js";

        let
            clips,
            action,
            mixer,
            clock,
            scene,
            camera,
            renderer,
            geometry,
            controls,
            gltfLoader,
            pointLight,
            ambientLight,
            directionalLight,
            envMap,
            mouse,
            raycaster,
            planets = [
                'sun',
                'brown',
                'black'
            ]

        const init = () => {

            //Animation
            clock = new THREE.Clock();

            //Scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, 100 / 100, 0.5, 10000);
            camera.position.x = 5000;
            camera.position.z = -1000;
            camera.position.y = -100;
            scene.add(camera);

            //Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);


            //Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.y = -100;
            controls.enabled = false;

            gltfLoader = new GLTFLoader();
            gltfLoader.load('./assets/model/Planets1/Planets_organized.gltf',
                (gltf) => {
                    scene.add(gltf.scene)
                    mixer = new THREE.AnimationMixer(gltf.scene);
                    clips = gltf.animations;
                    clips.forEach(function (clip) {
                        action = mixer.clipAction(clip);
                        action.timeScale = 1 / 30;
                        action.play()
                    });
                },
                () => { },
                () => { }
            );


            //Lights
            ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            pointLight = new THREE.PointLight(
                0xffffff,
                0.1,
                30
            );

            directionalLight = new THREE.DirectionalLight(
                0xffffff,
                0.5
            );

            pointLight.position.set(1, 10, 1)
            //scene.add(directionalLight);
            scene.add(ambientLight);

            //Mouse coors
            mouse = new THREE.Vector2();

            //Raycaster
            raycaster = new THREE.Raycaster();

            //Env map
            envMap = new THREE.CubeTextureLoader().load([
                './assets/env/px.png',
                './assets/env/nx.png',
                './assets/env/py.png',
                './assets/env/ny.png',
                './assets/env/pz.png',
                './assets/env/nz.png',
            ])

            scene.background = envMap;

            animate();
        }

        //Events
        const onClick = () => {
            raycaster.setFromCamera(mouse, camera);
            let intersects = raycaster.intersectObjects(scene.children);
            if (intersects.length > 0) {
                if (intersects[0].object.userData.name === 'Letrero.001') {
                    window.location.href = "https://www.google.com/";
                }
                return;
            }
        }

        //Hover planet-
        const onHover = () => {
            raycaster.setFromCamera(mouse, camera);
            let intersects = raycaster.intersectObjects(scene.children);
            if (intersects.length > 0) {
                for (let i = 0; i < intersects.length; i++) {
                    // console.log(intersects[i]);
                    // if (intersects[i].object.userData === {})
                    console.log(intersects[i].object);
                    //intersects[i].object.scale.set(83, 83, 83);
                    //     if (intersects[i].object.name === 'white') {
                    //         // if (intersects[i].object.id === 33) {
                    // intersects[i].object.scale.set(83, 83, 83);

                    // }

                    // }
                    // if (intersects[i].object.userData.name === 'orange') {
                    //     intersects[i].object.scale.set(83, 83, 83);
                    // }
                }
            }
        }

        //Reset planet hover
        const resetHover = () => {
            for (let i = 0; i < scene.children.length; i++) {
                if (scene.children[i].children[i]) {
                    //   scene.children[i].children[i].scale.set(80, 80, 80);
                }
            }
        }

        //Viewport mouse movement 
        const onMouseMove = (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        //Resize
        const onResize = () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        };

        //Render the scene
        const animate = () => {
            //Clock
            if (mixer)
                mixer.update(clock.getDelta());
            //Raycaster setup
            raycaster.setFromCamera(mouse, camera);
            //Reset hover new frame
            resetHover();
            //Hover new frame
            onHover();
            //Update controls
            controls.update();
            //Render scene
            renderer.render(scene, camera);
            //Request new frame
            requestAnimationFrame(animate);
        };

        window.addEventListener("load", onResize, false);
        window.addEventListener("resize", onResize, false);
        window.addEventListener("click", onClick, false);
        window.addEventListener("mousemove", onMouseMove, false);


        init();

    </script>
</body>

</html>